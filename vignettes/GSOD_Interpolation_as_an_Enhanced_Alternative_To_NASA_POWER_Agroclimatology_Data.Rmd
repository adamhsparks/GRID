---
title: "GRID"
author: "Adam H. Sparks - Centre for Crop Health, USQ"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GRID}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Global Surface Summary of the Day - GSOD data,
[(link)](https://data.noaa.gov/dataset/global-surface-summary-of-the-day-gsod)
is free, ground-based (or bouy) weather station data with global
coverage. When properly cleaned and interpolated this data can provide a better
alternative to NASA/POWER for agroclimatology work. This document describes how
to reproduce these data using freely available data, software and methodologies.

# Daily Weather Data Cleaning, Thin Plate Splining and Interpolation

GSOD temperature data are checked for consistency using `boxplot.stats()` to
identify and remove daily outliers for both TMAX and TMIN, separately.

Once the GSOD data are cleaned, thin plate splining, the `Tps()` function, from
 _fields_ is used to create an object that can then be used to create
an interpolated surface of temperatures using the SRTM DEM with the
`interpolate()` function from _raster_.

Use iterate through the data paralellising the process using _mclapply_:

1. check for outliers in GSOD data and remove them,

2. interpolate creating a global surface from the values,

3. write GeoTIFF files to disk for every day, every weather variable specified.

This is an extremly processor and time-intensive process for the entire global
dataset. It is suggested to use a computer dedicated just to this task, while it
will run on a fairly modest desktop, the computer may become unresponsive while
performing this operation.

### Step 1: Create a List of GSOD Data Files

First make a list of the GSOD weather data .csv files as documented in:
<https://github.com/adamhsparks/GRID/blob/master/data-raw/1_-_fetch_GSOD.md>

```{r file_list}
GSOD_list <- list.files("~/Data/GSOD", full.names = TRUE)
```
### Step 2: Interpolate the Data

Using a Linux, UNIX or macOS operating system, use `mclapply` to run the
function in parallel on all four cores available on the server, apply the
function over the list of GSOD data files. If using the `interp` function in
a Windows environment, set `mc.cores = 1`, else it will fail.

```{r run_interpolation, eval=FALSE, message='hide', results='hide'}
library(GRID)

# load the raster
dem <- raster::raster("~/Data/SRTM/SRTM_1deg.grd")

# Run the function
parallel::mclapply(X = GSOD_list,
                   FUN = interpolate_gsod,
                   dem = dem,
                   mc.cores = 4,
                   dsn = "/mnt/Cache/GTiff")
```
******

# Appendices

## R Session Information

```{r system information, echo=FALSE}

sessioninfo::session_info()

```
